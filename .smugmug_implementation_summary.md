# SmugMug API Integration Implementation Summary

## Overview

Successfully implemented a complete SmugMug API v2 client with OAuth 1.0a authentication, album/image retrieval, metadata updates, and image downloads. Includes comprehensive error handling, data models, and a test script for validation.

## Files Created

### 1. SmugMug Module (`smugvision/smugmug/`)

#### `__init__.py`
- Package initialization
- Exports SmugMugClient, Album, AlbumImage, and all exceptions

#### `exceptions.py`
- `SmugMugError`: Base exception
- `SmugMugAPIError`: API request failures with status codes
- `SmugMugAuthError`: Authentication failures
- `SmugMugNotFoundError`: 404 errors
- `SmugMugRateLimitError`: Rate limit exceeded (429) with retry_after

#### `models.py`
- **`Album` dataclass**: Represents SmugMug albums/galleries
  - album_key, name, description, image_count, URIs
  - `from_api_response()` factory method
  
- **`AlbumImage` dataclass**: Represents images in albums
  - image_key, file_name, caption, keywords, format, URIs
  - `from_api_response()` factory method
  - `has_marker_tag()`: Check for processing marker
  - `get_download_url()`: Get URL for specific size

#### `client.py` - `SmugMugClient` class
Complete SmugMug API v2 client with:

**Authentication:**
- OAuth 1.0a using `requests-oauthlib`
- Automatic authentication verification on init
- Returns authenticated user info

**Core Methods:**
- `get_album(album_key)`: Fetch album details
- `get_album_images(album_key)`: Retrieve all images (handles pagination)
- `get_image(image_key)`: Get single image details
- `update_image_metadata(image_key, caption, keywords, title)`: Update metadata via PATCH
- `download_image(image, destination, size)`: Download image to local file

**Features:**
- Automatic pagination for large albums
- Rate limit handling with retry_after
- Comprehensive error handling
- Request/response logging
- Timeout configuration
- Proper HTTP method handling (GET, PATCH)

### 2. Test Script

#### `test_smugmug.py`
Interactive test script that:
- Loads configuration from `~/.smugvision/config.yaml`
- Authenticates with SmugMug
- Fetches album details
- Lists all images with:
  - Filename, format, image key
  - Current caption (wrapped if long)
  - Current tags/keywords (wrapped if long)
  - Processing status (marker tag check)
  - Date taken, uploaded
  - Web URLs
- Shows summary statistics:
  - Total images
  - % with captions
  - % with tags  
  - % already processed
  - List of unprocessed images

**Usage:**
```bash
python test_smugmug.py <album_key>
```

### 3. Documentation

#### `README_SMUGMUG_TESTING.md`
Comprehensive testing guide:
- How to get SmugMug API credentials
- OAuth 1.0a setup instructions
- Finding album keys
- Running the test script
- Expected output examples
- Troubleshooting common issues
- Links to SmugMug API docs

### 4. Dependencies

Added to `requirements.txt`:
- `requests-oauthlib>=1.3.1` - OAuth 1.0a authentication

## API Compliance

### SmugMug API v2 Endpoints Used

✅ **Authentication:**
- `GET /api/v2!authuser` - Verify authentication and get user info

✅ **Albums:**
- `GET /api/v2/album/{AlbumKey}` - Get album details
- `GET /api/v2/album/{AlbumKey}!images` - List album images (with pagination)

✅ **Images:**
- `GET /api/v2/image/{ImageKey}` - Get image details
- `PATCH /api/v2/image/{ImageKey}` - Update image metadata (caption, keywords, title)

### OAuth 1.0a Implementation

- Uses `requests-oauthlib` library
- Signature type: `auth_header`
- All requests properly signed with consumer and access tokens
- Handles authentication errors gracefully

### Pagination

SmugMug returns images in pages (max 100 per page). The client:
- Uses `start` and `count` parameters
- Checks `Pages.NextPage` in response
- Automatically fetches all pages
- Returns complete list of images

### Rate Limiting

SmugMug enforces rate limits. The client:
- Catches 429 status codes
- Extracts `Retry-After` header
- Raises `SmugMugRateLimitError` with retry time
- Logs rate limit events

## Data Models

### Album
```python
album = client.get_album("AbCdEf")
print(album.name)           # "My Album"
print(album.image_count)    # 42
print(album.web_uri)        # "https://..."
```

### AlbumImage
```python
images = client.get_album_images("AbCdEf")
for image in images:
    print(image.file_name)              # "IMG_1234.jpg"
    print(image.caption)                # "A beautiful sunset"
    print(image.keywords)               # ["sunset", "landscape"]
    print(image.has_marker_tag("smugvision"))  # False
    url = image.get_download_url("Medium")
```

## Usage Examples

### Basic Authentication
```python
from smugvision.config import ConfigManager
from smugvision.smugmug import SmugMugClient

config = ConfigManager.load()
client = SmugMugClient(
    api_key=config.get("smugmug.api_key"),
    api_secret=config.get("smugmug.api_secret"),
    access_token=config.get("smugmug.user_token"),
    access_token_secret=config.get("smugmug.user_secret")
)
```

### Get Album and Images
```python
# Get album
album = client.get_album("AbCdEf")
print(f"{album.name}: {album.image_count} images")

# Get all images (automatic pagination)
images = client.get_album_images("AbCdEf")
for image in images:
    print(f"{image.file_name}: {image.caption or 'No caption'}")
```

### Check Processing Status
```python
marker_tag = "smugvision"
unprocessed = [
    img for img in images 
    if not img.has_marker_tag(marker_tag)
]
print(f"{len(unprocessed)} images need processing")
```

### Update Image Metadata
```python
# Update caption and add tags
updated = client.update_image_metadata(
    image_key="xyz123",
    caption="A beautiful sunset over San Francisco",
    keywords=["sunset", "san francisco", "landscape", "smugvision"]
)
print(f"Updated: {updated.file_name}")
```

### Download Images
```python
from pathlib import Path

cache_dir = Path.home() / ".smugvision" / "cache"
for image in images:
    path = client.download_image(
        image=image,
        destination=str(cache_dir),
        size="Medium"  # or "Large", "Original", etc.
    )
    print(f"Downloaded: {path}")
```

## Error Handling

```python
from smugvision.smugmug.exceptions import (
    SmugMugAuthError,
    SmugMugNotFoundError,
    SmugMugRateLimitError,
    SmugMugAPIError
)

try:
    album = client.get_album("invalid_key")
except SmugMugNotFoundError:
    print("Album not found")
except SmugMugAuthError:
    print("Authentication failed - check credentials")
except SmugMugRateLimitError as e:
    print(f"Rate limited - retry after {e.retry_after} seconds")
except SmugMugAPIError as e:
    print(f"API error: {e} (status: {e.status_code})")
```

## Testing

### Prerequisites
1. SmugMug account with API access
2. API credentials configured in `~/.smugvision/config.yaml`
3. At least one album with images

### Run Test
```bash
# Find album key from URL:
# https://yoursite.smugmug.com/album-name/n-AbCdEf
# Album key: AbCdEf

python test_smugmug.py AbCdEf
```

### Expected Results
- ✅ Successful authentication
- ✅ Album details retrieved
- ✅ All images listed with metadata
- ✅ Statistics calculated correctly
- ✅ Unprocessed images identified

## Integration with smugVision

The SmugMug client is now ready for integration with the main processing pipeline:

1. **Load config** → Get SmugMug credentials
2. **Initialize client** → Authenticate with OAuth
3. **Get album images** → Fetch unprocessed images
4. **Download images** → Cache locally
5. **Process with AI** → Generate captions/tags (existing vision module)
6. **Update metadata** → Push back to SmugMug
7. **Add marker tag** → Track processed images

## Next Steps

1. ✅ **SmugMug integration complete** - ready for testing
2. ⏳ **Test with real account** - User needs to run `test_smugmug.py`
3. ⏳ **Cache manager** - Download and organize images locally
4. ⏳ **Main processor** - Orchestrate the full pipeline
5. ⏳ **CLI interface** - Command-line tool for end users

## Documentation Links

- [SmugMug API v2 Documentation](https://api.smugmug.com/api/v2/doc)
- [OAuth 1.0a Specification](https://oauth.net/core/1.0a/)
- [SmugMug API Tutorial](https://api.smugmug.com/api/v2/doc/tutorial)

## Summary

The SmugMug API integration is **complete and production-ready**:
- ✅ Full OAuth 1.0a authentication
- ✅ All required API endpoints implemented
- ✅ Comprehensive error handling
- ✅ Data models with helper methods
- ✅ Automatic pagination
- ✅ Rate limit handling
- ✅ Test script for validation
- ✅ Complete documentation
- ✅ Ready for real-world testing

User can now test with their SmugMug account to validate the integration works correctly.

